

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Toggle TMR Example &mdash; SpyDrNet TMR 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-rendered-html.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Registered Inverter TMR Example" href="plot_registered_inverter_tmr.html" />
    <link rel="prev" title="Uniquify NMR Property Example" href="uniquify_nmr_property_example.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> SpyDrNet TMR
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Examples</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#basic">Basic</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="plot_generic_tmr.html">Basic TMR</a></li>
<li class="toctree-l3"><a class="reference internal" href="uniquify_nmr_property_example.html">Uniquify NMR Property Example</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Toggle TMR Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_registered_inverter_tmr.html">Registered Inverter TMR Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="surface_pins_example.html">Surface Pins Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="toggle_dwc.html">Toggle DWC Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_xilinx_generic_tmr.html">Xilinx TMR</a></li>
<li class="toctree-l3"><a class="reference internal" href="using_drc_example.html">Design Rule Check Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_voters_for_every_ff_tmr.html">Voter Before/After Every Flip-Flop Algorithms</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_counter_bitstream_tmr.html">Two-Bit Counter Bitstream TMR</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SpyDrNet TMR</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Examples</a> &raquo;</li>
        
      <li>Toggle TMR Example</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/auto_examples/basic/toggle_tmr.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-auto-examples-basic-toggle-tmr-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="toggle-tmr-example">
<span id="sphx-glr-auto-examples-basic-toggle-tmr-py"></span><h1>Toggle TMR Example<a class="headerlink" href="#toggle-tmr-example" title="Permalink to this headline">¶</a></h1>
<p>This is an example of doing TMR on a basic design using SpyDrNet TMR.</p>
<p>First, we start with a simple design that includes a LUT and a flip flop. The following block is SystemVerilog code:</p>
<div class="highlight-sv notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">toggle</span><span class="p">(</span>
   <span class="k">input</span> <span class="kt">wire</span> <span class="kt">logic</span> <span class="n">clk</span><span class="p">,</span> <span class="n">reset</span><span class="p">,</span>
   <span class="k">output</span> <span class="kt">logic</span> <span class="n">out</span>
   <span class="p">);</span>

   <span class="k">always_ff</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span>
         <span class="n">out</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">else</span>
         <span class="n">out</span> <span class="o">&lt;=</span> <span class="o">~</span><span class="n">out</span><span class="p">;</span>
<span class="k">endmodule</span>
</pre></div>
</div>
<div class="figure align-center" id="id1">
<a class="reference internal image-reference" href="../../_images/toggle_original.png"><img alt="../../_images/toggle_original.png" src="../../_images/toggle_original.png" style="width: 600px;" /></a>
<p class="caption"><span class="caption-text">Original Design</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<p>Then we find the instances and ports to replicate. Note that in the following code that the only ports specified to be triplicated are the input ports that are not the clock (so just the reset port). We also find the voter insertion points.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hinstances_to_replicate</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">netlist</span><span class="o">.</span><span class="n">get_hinstances</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">reference</span><span class="o">.</span><span class="n">is_leaf</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">))</span>
<span class="n">instances_to_replicate</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">item</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hinstances_to_replicate</span><span class="p">)</span>

<span class="n">hports_to_replicate</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">netlist</span><span class="o">.</span><span class="n">get_hports</span><span class="p">(</span><span class="nb">filter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">direction</span> <span class="ow">is</span> <span class="n">sdn</span><span class="o">.</span><span class="n">IN</span><span class="p">))</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hports_to_replicate</span><span class="p">:</span>
   <span class="k">if</span> <span class="s2">&quot;clk&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
      <span class="n">hports_to_replicate</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ports_to_replicate</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">item</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hports_to_replicate</span><span class="p">)</span>

<span class="n">insertion_points</span> <span class="o">=</span> <span class="n">find_voter_insertion_points_after_ff</span><span class="p">([</span><span class="o">*</span><span class="n">hinstances_to_replicate</span><span class="p">,</span> <span class="o">*</span><span class="n">hports_to_replicate</span><span class="p">],</span> <span class="p">{</span><span class="s1">&#39;FDRE&#39;</span><span class="p">,</span> <span class="s1">&#39;FDSE&#39;</span><span class="p">,</span> <span class="s1">&#39;FDPE&#39;</span><span class="p">,</span> <span class="s1">&#39;FDCE&#39;</span><span class="p">})</span>
</pre></div>
</div>
<p>Next, we triplicate the design using apply_nmr(). The instances and ports we specified are passed as two of the parameters. We also pass ‘3’ and ‘TMR’ as number of replications and the applicable suffix, respectively.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">replicas</span> <span class="o">=</span> <span class="n">apply_nmr</span><span class="p">([</span><span class="o">*</span><span class="n">instances_to_replicate</span><span class="p">,</span> <span class="o">*</span><span class="n">ports_to_replicate</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span> <span class="n">name_suffix</span><span class="o">=</span><span class="s1">&#39;TMR&#39;</span><span class="p">,</span> <span class="n">rename_original</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="figure align-center" id="id2">
<a class="reference internal image-reference" href="../../_images/toggle_just_tmr.png"><img alt="../../_images/toggle_just_tmr.png" src="../../_images/toggle_just_tmr.png" style="width: 600px;" /></a>
<p class="caption"><span class="caption-text">Design After Triplication</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
<p>Then we insert voters using insert_organs().</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">voters</span> <span class="o">=</span> <span class="n">insert_organs</span><span class="p">(</span><span class="n">replicas</span><span class="p">,</span> <span class="n">insertion_points</span><span class="p">,</span> <span class="n">XilinxTMRVoter</span><span class="p">(),</span> <span class="s1">&#39;VOTER&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>While viewing the schematic, note that the voters’ outputs feed back into the flip flops. This will get the flip flop onto the correct state if its previous output was outvoted. Also note that one of the voters outputs to the ‘out’ port.</p>
<div class="figure align-center" id="id3">
<a class="reference internal image-reference" href="../../_images/toggle_tmr_with_voters.png"><img alt="../../_images/toggle_tmr_with_voters.png" src="../../_images/toggle_tmr_with_voters.png" style="width: 600px;" /></a>
<p class="caption"><span class="caption-text">Final Design</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<p><strong>See the full code below</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">spydrnet</span> <span class="k">as</span> <span class="nn">sdn</span>
<span class="kn">from</span> <span class="nn">spydrnet.uniquify</span> <span class="kn">import</span> <span class="n">uniquify</span>
<span class="kn">from</span> <span class="nn">spydrnet_tmr</span> <span class="kn">import</span> <span class="n">apply_nmr</span><span class="p">,</span> <span class="n">insert_organs</span>
<span class="kn">from</span> <span class="nn">spydrnet_tmr.analysis.voter_insertion.find_voter_insertion_points_after_ff</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">find_voter_insertion_points_after_ff</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">spydrnet_tmr.transformation.replication.organ</span> <span class="kn">import</span> <span class="n">XilinxTMRVoter</span>


<span class="n">netlist</span> <span class="o">=</span> <span class="n">sdn</span><span class="o">.</span><span class="n">load_example_netlist_by_name</span><span class="p">(</span><span class="s2">&quot;toggle&quot;</span><span class="p">)</span>

<span class="n">uniquify</span><span class="p">(</span><span class="n">netlist</span><span class="p">)</span>

<span class="n">hinstances_to_replicate</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
    <span class="n">netlist</span><span class="o">.</span><span class="n">get_hinstances</span><span class="p">(</span>
        <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">reference</span><span class="o">.</span><span class="n">is_leaf</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">True</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">instances_to_replicate</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">item</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hinstances_to_replicate</span><span class="p">)</span>

<span class="n">hports_to_replicate</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
    <span class="n">netlist</span><span class="o">.</span><span class="n">get_hports</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">direction</span> <span class="ow">is</span> <span class="n">sdn</span><span class="o">.</span><span class="n">IN</span><span class="p">)</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hports_to_replicate</span><span class="p">:</span>
   <span class="k">if</span> <span class="s2">&quot;clk&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
      <span class="n">hports_to_replicate</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">ports_to_replicate</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">item</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">hports_to_replicate</span><span class="p">)</span>

<span class="n">insertion_points</span> <span class="o">=</span> <span class="n">find_voter_insertion_points_after_ff</span><span class="p">(</span>
    <span class="p">[</span><span class="o">*</span><span class="n">hinstances_to_replicate</span><span class="p">,</span> <span class="o">*</span><span class="n">hports_to_replicate</span><span class="p">],</span>
    <span class="p">{</span><span class="s2">&quot;FDRE&quot;</span><span class="p">,</span> <span class="s2">&quot;FDSE&quot;</span><span class="p">,</span> <span class="s2">&quot;FDPE&quot;</span><span class="p">,</span> <span class="s2">&quot;FDCE&quot;</span><span class="p">},</span>
<span class="p">)</span>

<span class="n">replicas</span> <span class="o">=</span> <span class="n">apply_nmr</span><span class="p">(</span>
    <span class="p">[</span><span class="o">*</span><span class="n">instances_to_replicate</span><span class="p">,</span> <span class="o">*</span><span class="n">ports_to_replicate</span><span class="p">],</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="n">name_suffix</span><span class="o">=</span><span class="s2">&quot;TMR&quot;</span><span class="p">,</span>
    <span class="n">rename_original</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">voters</span> <span class="o">=</span> <span class="n">insert_organs</span><span class="p">(</span><span class="n">replicas</span><span class="p">,</span> <span class="n">insertion_points</span><span class="p">,</span> <span class="n">XilinxTMRVoter</span><span class="p">(),</span> <span class="s2">&quot;VOTER&quot;</span><span class="p">)</span>

<span class="n">netlist</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="s2">&quot;toggle_tmr.edf&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  0.000 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-basic-toggle-tmr-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/334f0966e472b57945314a07537f76f7/toggle_tmr.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">toggle_tmr.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/6e900ef524fba60f1903256fb72e379e/toggle_tmr.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">toggle_tmr.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="plot_registered_inverter_tmr.html" class="btn btn-neutral float-right" title="Registered Inverter TMR Example" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="uniquify_nmr_property_example.html" class="btn btn-neutral float-left" title="Uniquify NMR Property Example" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, BYU Configurable Computing Lab.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
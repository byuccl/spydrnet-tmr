

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Two-Bit Counter Bitstream TMR &mdash; SpyDrNet TMR 1.2.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-rendered-html.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="YAML Configuration Mode for Triplication" href="plot_config_tmr.html" />
    <link rel="prev" title="Design Rule Check Example" href="using_drc_example.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> SpyDrNet TMR
          

          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Examples</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#basic">Basic</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="plot_generic_tmr.html">Basic TMR</a></li>
<li class="toctree-l3"><a class="reference internal" href="toggle_tmr.html">Toggle TMR Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="uniquify_nmr_property_example.html">Uniquify NMR Property Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_registered_inverter_tmr.html">Registered Inverter TMR Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="surface_pins_example.html">Surface Pins Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_voters_for_every_ff_tmr.html">Voter Before/After Every Flip-Flop Algorithms</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_xilinx_generic_tmr.html">Xilinx TMR</a></li>
<li class="toctree-l3"><a class="reference internal" href="toggle_dwc.html">Toggle DWC Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="using_drc_example.html">Design Rule Check Example</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Two-Bit Counter Bitstream TMR</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_config_tmr.html">YAML Configuration Mode for Triplication</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../symbiflow/index.html">SpyDrNet-TMR and Symbiflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SpyDrNet TMR</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Examples</a> &raquo;</li>
        
      <li>Two-Bit Counter Bitstream TMR</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/auto_examples/basic/plot_counter_bitstream_tmr.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-auto-examples-basic-plot-counter-bitstream-tmr-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="two-bit-counter-bitstream-tmr">
<span id="sphx-glr-auto-examples-basic-plot-counter-bitstream-tmr-py"></span><h1>Two-Bit Counter Bitstream TMR<a class="headerlink" href="#two-bit-counter-bitstream-tmr" title="Permalink to this headline">¶</a></h1>
<p>Triplicates different circuit elements and inserts voters into simple two-bit
counter design</p>
<p>In this example, a simple design with a two-bit counter with a one-shot detector for a Digilent BASYS3 board is used. The example is included in the <cite>spydernet_TMR/support_files/EDIF_netlists</cite> folder.</p>
<p>Below is are the SystemVerilog modules used to create the design, as well as an .xdc constraints file.</p>
<div class="highlight-sv notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">two_bit_counter_top</span><span class="p">(</span>
    <span class="k">input</span> <span class="kt">wire</span> <span class="kt">logic</span> <span class="n">btnC</span><span class="p">,</span> <span class="n">btnU</span><span class="p">,</span> <span class="n">clk</span><span class="p">,</span>
    <span class="k">output</span> <span class="kt">logic</span> <span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">led</span>
<span class="p">);</span>

    <span class="kt">logic</span> <span class="n">btnU_one_shot</span><span class="p">;</span>

    <span class="n">one_shot</span> <span class="n">one_shot</span><span class="p">(.</span><span class="n">btn_press</span><span class="p">(</span><span class="n">btnU</span><span class="p">),</span> <span class="p">.</span><span class="n">btn_output</span><span class="p">(</span><span class="n">btnU_one_shot</span><span class="p">),</span> <span class="p">.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">));</span>

    <span class="n">two_bit_counter</span> <span class="n">two_bit_conter</span><span class="p">(</span>
        <span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">btnC</span><span class="p">),</span> <span class="p">.</span><span class="n">clk</span><span class="p">(</span><span class="n">clk</span><span class="p">),</span> <span class="p">.</span><span class="n">increment</span><span class="p">(</span><span class="n">btnU_one_shot</span><span class="p">),</span> <span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">led</span><span class="p">)</span>
    <span class="p">);</span>

<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-sv notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">one_shot</span><span class="p">(</span>
    <span class="k">input</span> <span class="kt">wire</span> <span class="kt">logic</span> <span class="n">btn_press</span><span class="p">,</span> <span class="n">clk</span><span class="p">,</span>
    <span class="k">output</span> <span class="kt">logic</span> <span class="n">btn_output</span>
<span class="p">);</span>

    <span class="kt">logic</span> <span class="n">btn_f1</span><span class="p">,</span> <span class="n">btn_f2</span><span class="p">;</span>

    <span class="k">always_ff</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span><span class="p">)</span> <span class="k">begin</span>
        <span class="n">btn_f1</span> <span class="o">&lt;=</span> <span class="n">btn_press</span><span class="p">;</span>
        <span class="n">btn_f2</span> <span class="o">&lt;=</span> <span class="n">btn_f1</span><span class="p">;</span>
    <span class="k">end</span>

    <span class="k">assign</span> <span class="n">btn_output</span> <span class="o">=</span> <span class="n">btn_f1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">btn_f2</span><span class="p">;</span>

<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-sv notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="n">two_bit_counter</span><span class="p">(</span>
    <span class="k">input</span> <span class="kt">wire</span> <span class="kt">logic</span> <span class="n">reset</span><span class="p">,</span> <span class="n">increment</span><span class="p">,</span> <span class="n">clk</span><span class="p">,</span>
    <span class="k">output</span> <span class="kt">logic</span> <span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="n">count</span>
<span class="p">);</span>


    <span class="k">always_ff</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span><span class="p">)</span> <span class="k">begin</span>
        <span class="k">if</span><span class="p">(</span><span class="n">reset</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">increment</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">&lt;=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">end</span>

<span class="k">endmodule</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Clock signal</span>
<span class="n">set_property</span> <span class="n">PACKAGE_PIN</span> <span class="n">W5</span> <span class="p">[</span><span class="n">get_ports</span> <span class="n">clk</span><span class="p">]</span>
    <span class="n">set_property</span> <span class="n">IOSTANDARD</span> <span class="n">LVCMOS33</span> <span class="p">[</span><span class="n">get_ports</span> <span class="n">clk</span><span class="p">]</span>
    <span class="n">create_clock</span> <span class="o">-</span><span class="n">add</span> <span class="o">-</span><span class="n">name</span> <span class="n">sys_clk_pin</span> <span class="o">-</span><span class="n">period</span> <span class="mf">10.00</span> <span class="o">-</span><span class="n">waveform</span> <span class="p">{</span><span class="mi">0</span> <span class="mi">5</span><span class="p">}</span> <span class="p">[</span><span class="n">get_ports</span> <span class="n">clk</span><span class="p">]</span>

<span class="c1"># LEDs</span>
<span class="n">set_property</span> <span class="n">PACKAGE_PIN</span> <span class="n">U16</span> <span class="p">[</span><span class="n">get_ports</span> <span class="p">{</span><span class="n">led</span><span class="p">[</span><span class="mi">0</span><span class="p">]}]</span>
    <span class="n">set_property</span> <span class="n">IOSTANDARD</span> <span class="n">LVCMOS33</span> <span class="p">[</span><span class="n">get_ports</span> <span class="p">{</span><span class="n">led</span><span class="p">[</span><span class="mi">0</span><span class="p">]}]</span>
<span class="n">set_property</span> <span class="n">PACKAGE_PIN</span> <span class="n">E19</span> <span class="p">[</span><span class="n">get_ports</span> <span class="p">{</span><span class="n">led</span><span class="p">[</span><span class="mi">1</span><span class="p">]}]</span>
    <span class="n">set_property</span> <span class="n">IOSTANDARD</span> <span class="n">LVCMOS33</span> <span class="p">[</span><span class="n">get_ports</span> <span class="p">{</span><span class="n">led</span><span class="p">[</span><span class="mi">1</span><span class="p">]}]</span>

<span class="c1"># Buttons</span>
<span class="n">set_property</span> <span class="n">PACKAGE_PIN</span> <span class="n">U18</span> <span class="p">[</span><span class="n">get_ports</span> <span class="n">btnC</span><span class="p">]</span>
    <span class="n">set_property</span> <span class="n">IOSTANDARD</span> <span class="n">LVCMOS33</span> <span class="p">[</span><span class="n">get_ports</span> <span class="n">btnC</span><span class="p">]</span>
<span class="n">set_property</span> <span class="n">PACKAGE_PIN</span> <span class="n">T18</span> <span class="p">[</span><span class="n">get_ports</span> <span class="n">btnU</span><span class="p">]</span>
    <span class="n">set_property</span> <span class="n">IOSTANDARD</span> <span class="n">LVCMOS33</span> <span class="p">[</span><span class="n">get_ports</span> <span class="n">btnU</span><span class="p">]</span>

<span class="n">set_property</span> <span class="n">CONFIG_VOLTAGE</span> <span class="mf">3.3</span> <span class="p">[</span><span class="n">current_design</span><span class="p">]</span>
<span class="n">set_property</span> <span class="n">CFGBVS</span> <span class="n">VCCO</span> <span class="p">[</span><span class="n">current_design</span><span class="p">]</span>
</pre></div>
</div>
<p>Note that this example does not use the <cite>apply_tmr_to_netlist</cite>, but rather shows how TMR can be applied without using that function in the case that customization is required.</p>
<p>SpyDrNet TMR allows for some flexibility when it comes to replicating instances and ports, and this is shown here in this example. Only the two LED ports (‘led[1:0]’) will be replicated from all of the top ports, which means the total LEDs used in the final netlist will be 6 (2 LEDs x 3 = 6 LEDs). All instances inside the netlist will be replicated.</p>
<p>The SpyDrNet TMR TMR flow generally follows this set of steps:
1. Parse in a netlist with SpyDrNet. This can be done either by loading in your own netlist with <cite>spydrnet.parse(&lt;filename&gt;)</cite> or a pre-existing netlist with <cite>spydrnet.load_example_netlist_by_name(&lt;name&gt;)</cite> (SpyDrNet-TMR has its own examples that can be loaded similarly with <cite>spydrnet_tmr.load_example_netlist_by_name(&lt;name&gt;)</cite>)
2. Set which instances to replicate. This example replicates all instances.
3. Set which ports to replicate. This example selects all hierarchical ports (ports between hierarchical modules), and only the LED port from the top-level ports.
4. Find insertion points for reduction and feedback voters.
5. Replicate the previously selected instances and ports.
6. Insert voters at the previously selected insertion points.</p>
<p>Here is the constraints file for the design after triplication. The only difference is the constraints for all six of the new two-bit counter outputs.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Clock signal</span>
<span class="n">set_property</span> <span class="n">PACKAGE_PIN</span> <span class="n">W5</span> <span class="p">[</span><span class="n">get_ports</span> <span class="n">clk</span><span class="p">]</span>
    <span class="n">set_property</span> <span class="n">IOSTANDARD</span> <span class="n">LVCMOS33</span> <span class="p">[</span><span class="n">get_ports</span> <span class="n">clk</span><span class="p">]</span>
    <span class="n">create_clock</span> <span class="o">-</span><span class="n">add</span> <span class="o">-</span><span class="n">name</span> <span class="n">sys_clk_pin</span> <span class="o">-</span><span class="n">period</span> <span class="mf">10.00</span> <span class="o">-</span><span class="n">waveform</span> <span class="p">{</span><span class="mi">0</span> <span class="mi">5</span><span class="p">}</span> <span class="p">[</span><span class="n">get_ports</span> <span class="n">clk</span><span class="p">]</span>

<span class="c1"># LEDs</span>
<span class="n">set_property</span> <span class="n">PACKAGE_PIN</span> <span class="n">U16</span> <span class="p">[</span><span class="n">get_ports</span> <span class="p">{</span><span class="n">led_TMR_0</span><span class="p">[</span><span class="mi">0</span><span class="p">]}]</span>
    <span class="n">set_property</span> <span class="n">IOSTANDARD</span> <span class="n">LVCMOS33</span> <span class="p">[</span><span class="n">get_ports</span> <span class="p">{</span><span class="n">led_TMR_0</span><span class="p">[</span><span class="mi">0</span><span class="p">]}]</span>
<span class="n">set_property</span> <span class="n">PACKAGE_PIN</span> <span class="n">E19</span> <span class="p">[</span><span class="n">get_ports</span> <span class="p">{</span><span class="n">led_TMR_0</span><span class="p">[</span><span class="mi">1</span><span class="p">]}]</span>
    <span class="n">set_property</span> <span class="n">IOSTANDARD</span> <span class="n">LVCMOS33</span> <span class="p">[</span><span class="n">get_ports</span> <span class="p">{</span><span class="n">led_TMR_0</span><span class="p">[</span><span class="mi">1</span><span class="p">]}]</span>
<span class="n">set_property</span> <span class="n">PACKAGE_PIN</span> <span class="n">U19</span> <span class="p">[</span><span class="n">get_ports</span> <span class="p">{</span><span class="n">led_TMR_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]}]</span>
    <span class="n">set_property</span> <span class="n">IOSTANDARD</span> <span class="n">LVCMOS33</span> <span class="p">[</span><span class="n">get_ports</span> <span class="p">{</span><span class="n">led_TMR_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]}]</span>
<span class="n">set_property</span> <span class="n">PACKAGE_PIN</span> <span class="n">V19</span> <span class="p">[</span><span class="n">get_ports</span> <span class="p">{</span><span class="n">led_TMR_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]}]</span>
    <span class="n">set_property</span> <span class="n">IOSTANDARD</span> <span class="n">LVCMOS33</span> <span class="p">[</span><span class="n">get_ports</span> <span class="p">{</span><span class="n">led_TMR_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]}]</span>
<span class="n">set_property</span> <span class="n">PACKAGE_PIN</span> <span class="n">W18</span> <span class="p">[</span><span class="n">get_ports</span> <span class="p">{</span><span class="n">led_TMR_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]}]</span>
    <span class="n">set_property</span> <span class="n">IOSTANDARD</span> <span class="n">LVCMOS33</span> <span class="p">[</span><span class="n">get_ports</span> <span class="p">{</span><span class="n">led_TMR_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]}]</span>
<span class="n">set_property</span> <span class="n">PACKAGE_PIN</span> <span class="n">U15</span> <span class="p">[</span><span class="n">get_ports</span> <span class="p">{</span><span class="n">led_TMR_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]}]</span>
    <span class="n">set_property</span> <span class="n">IOSTANDARD</span> <span class="n">LVCMOS33</span> <span class="p">[</span><span class="n">get_ports</span> <span class="p">{</span><span class="n">led_TMR_2</span><span class="p">[</span><span class="mi">1</span><span class="p">]}]</span>

<span class="c1"># Buttons</span>
<span class="n">set_property</span> <span class="n">PACKAGE_PIN</span> <span class="n">U18</span> <span class="p">[</span><span class="n">get_ports</span> <span class="n">btnC</span><span class="p">]</span>
    <span class="n">set_property</span> <span class="n">IOSTANDARD</span> <span class="n">LVCMOS33</span> <span class="p">[</span><span class="n">get_ports</span> <span class="n">btnC</span><span class="p">]</span>
<span class="n">set_property</span> <span class="n">PACKAGE_PIN</span> <span class="n">T18</span> <span class="p">[</span><span class="n">get_ports</span> <span class="n">btnU</span><span class="p">]</span>
    <span class="n">set_property</span> <span class="n">IOSTANDARD</span> <span class="n">LVCMOS33</span> <span class="p">[</span><span class="n">get_ports</span> <span class="n">btnU</span><span class="p">]</span>

<span class="n">set_property</span> <span class="n">CONFIG_VOLTAGE</span> <span class="mf">3.3</span> <span class="p">[</span><span class="n">current_design</span><span class="p">]</span>
<span class="n">set_property</span> <span class="n">CFGBVS</span> <span class="n">VCCO</span> <span class="p">[</span><span class="n">current_design</span><span class="p">]</span>
</pre></div>
</div>
<p>This script will also build a bitstream if desired. To build it, simple set the <cite>build_bitstream_flag</cite> boolean to ‘True’ at the top of the script. A TCL script for Vivado’s batch mode will be created that will load in the TMR netlist and build a bitstream for the correct part for the FPGA on the BASYS3 board. If Vivado is installed correctly, the script will then execute the commands in the auto-generated TCL script, and if successful, will output a bitstream (.bit) file ready to be downloaded to a board.</p>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Identified 0 insertion points for reduction voters.
Identified 4 insertion points for feedback voters after flip-flop.
</pre></div>
</div>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="kn">from</span> <span class="nn">spydrnet.uniquify</span> <span class="kn">import</span> <span class="n">uniquify</span>
<span class="kn">import</span> <span class="nn">spydrnet_tmr</span>
<span class="kn">from</span> <span class="nn">spydrnet_tmr.apply_tmr_to_netlist</span> <span class="kn">import</span> <span class="n">apply_tmr_to_netlist</span>
<span class="kn">from</span> <span class="nn">spydrnet_tmr.support_files.vendor_names</span> <span class="kn">import</span> <span class="n">XILINX</span>

<span class="c1"># Set this flag to &#39;True&#39; to build the bitstream, and &#39;False&#39; to skip it</span>
<span class="n">build_bitstream_flag</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">run</span><span class="p">():</span>

    <span class="n">netlist_name</span> <span class="o">=</span> <span class="s2">&quot;two_bit_counter_top&quot;</span>
    <span class="n">netlist</span> <span class="o">=</span> <span class="n">spydrnet_tmr</span><span class="o">.</span><span class="n">load_example_netlist_by_name</span><span class="p">(</span><span class="n">netlist_name</span><span class="p">)</span>

    <span class="n">uniquify</span><span class="p">(</span><span class="n">netlist</span><span class="p">)</span>

    <span class="c1"># set instances_to_replicate [get_cells -hierarchical -filter {PRIMITIVE_LEVEL==LEAF||PRIMITIVE_LEVEL==MACRO}]</span>
    <span class="n">hinstances_to_replicate</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="n">netlist</span><span class="o">.</span><span class="n">get_hinstances</span><span class="p">(</span>
            <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">reference</span><span class="o">.</span><span class="n">is_leaf</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">True</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># set ports_to_replicate [get_ports]</span>
    <span class="n">hports_to_replicate</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="n">netlist</span><span class="o">.</span><span class="n">get_hports</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;led[1:0]&quot;</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="n">valid_voter_point_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">valid_voter_point_dict</span><span class="p">[</span><span class="s2">&quot;reduction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="o">*</span><span class="n">hinstances_to_replicate</span><span class="p">,</span>
        <span class="o">*</span><span class="n">hports_to_replicate</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">valid_voter_point_dict</span><span class="p">[</span><span class="s2">&quot;after_ff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="o">*</span><span class="n">hinstances_to_replicate</span><span class="p">,</span>
        <span class="o">*</span><span class="n">hports_to_replicate</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">apply_tmr_to_netlist</span><span class="p">(</span>
        <span class="n">netlist</span><span class="p">,</span>
        <span class="n">XILINX</span><span class="p">,</span>
        <span class="n">hinstances_and_hports_to_replicate</span><span class="o">=</span><span class="p">[</span>
            <span class="o">*</span><span class="n">hinstances_to_replicate</span><span class="p">,</span>
            <span class="o">*</span><span class="n">hports_to_replicate</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="n">valid_voter_point_dict</span><span class="o">=</span><span class="n">valid_voter_point_dict</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">netlist_tmr_name</span> <span class="o">=</span> <span class="n">netlist_name</span> <span class="o">+</span> <span class="s2">&quot;_tmr&quot;</span>

    <span class="n">netlist</span><span class="o">.</span><span class="n">compose</span><span class="p">(</span><span class="n">netlist_tmr_name</span> <span class="o">+</span> <span class="s2">&quot;.edf&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">build_bitstream_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>

        <span class="n">repo_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="c1"># part for basys3 board</span>
        <span class="n">part</span> <span class="o">=</span> <span class="s2">&quot;xc7a35tcpg236-1&quot;</span>

        <span class="n">build_bitstream_from_netlist</span><span class="p">(</span><span class="n">repo_path</span><span class="p">,</span> <span class="n">netlist_tmr_name</span><span class="p">,</span> <span class="n">part</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">build_bitstream_from_netlist</span><span class="p">(</span><span class="n">extract_path</span><span class="p">,</span> <span class="n">netlist_name</span><span class="p">,</span> <span class="n">part</span><span class="p">):</span>

    <span class="c1"># build_set = [&quot;datapath&quot;, [&quot;xdc&quot;], [ &quot;constants&quot;, &quot;alu&quot;, &quot;regfile&quot;, &quot;datapath&quot; ] ]</span>

    <span class="n">bitfile_filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">netlist_name</span> <span class="o">+</span> <span class="s2">&quot;.bit&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Attempting to build bitfile &quot;</span><span class="p">,</span> <span class="n">bitfile_filename</span><span class="p">)</span>

    <span class="n">tcl_build_script_filename</span> <span class="o">=</span> <span class="n">create_tcl_build_script</span><span class="p">(</span>
        <span class="n">extract_path</span><span class="p">,</span> <span class="n">netlist_name</span><span class="p">,</span> <span class="n">part</span>
    <span class="p">)</span>

    <span class="c1"># Generate bitfile</span>
    <span class="n">build_cmd</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;vivado&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-nolog&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-mode&quot;</span><span class="p">,</span>
        <span class="s2">&quot;batch&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-nojournal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-source&quot;</span><span class="p">,</span>
        <span class="n">tcl_build_script_filename</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">build_cmd</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="n">extract_path</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># See if the bitfile exists (make sure it is newer)</span>
    <span class="n">bitstream_file</span> <span class="o">=</span> <span class="n">extract_path</span> <span class="o">/</span> <span class="n">bitfile_filename</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bitstream_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bistream file &quot;</span><span class="p">,</span> <span class="n">bitstream_file</span><span class="p">,</span> <span class="s2">&quot; not created&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bitstream file &quot;</span><span class="p">,</span> <span class="n">bitstream_file</span><span class="p">,</span> <span class="s2">&quot; exists&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">create_tcl_build_script</span><span class="p">(</span><span class="n">extract_path</span><span class="p">,</span> <span class="n">netlist_name</span><span class="p">,</span> <span class="n">part</span><span class="p">):</span>
    <span class="n">tcl_build_script_filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">netlist_name</span> <span class="o">+</span> <span class="s2">&quot;_buildscript.tcl&quot;</span><span class="p">)</span>
    <span class="n">tmp_tcl</span> <span class="o">=</span> <span class="n">extract_path</span> <span class="o">/</span> <span class="n">tcl_build_script_filename</span>

    <span class="n">log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp_tcl</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Bitfile Generation script</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Add netlist source</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;read_edif &quot;</span> <span class="o">+</span> <span class="n">netlist_name</span> <span class="o">+</span> <span class="s2">&quot;.edf&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Add XDC file</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;read_xdc &quot;</span> <span class="o">+</span> <span class="n">netlist_name</span> <span class="o">+</span> <span class="s2">&quot;.xdc&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Set source and part</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;link_design -name &quot;</span> <span class="o">+</span> <span class="n">netlist_name</span> <span class="o">+</span> <span class="s2">&quot; -part &quot;</span> <span class="o">+</span> <span class="n">part</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Implement Design</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;place_design</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;route_design</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;write_bitstream -force &quot;</span> <span class="o">+</span> <span class="n">netlist_name</span> <span class="o">+</span> <span class="s2">&quot;.bit&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# End of build script</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">tcl_build_script_filename</span>


<span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  0.040 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-basic-plot-counter-bitstream-tmr-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/c5ed0e0ff1e2a540237efaa8a77528ea/plot_counter_bitstream_tmr.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_counter_bitstream_tmr.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/cca70a87054aa07084a89e3a1cc99900/plot_counter_bitstream_tmr.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_counter_bitstream_tmr.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="plot_config_tmr.html" class="btn btn-neutral float-right" title="YAML Configuration Mode for Triplication" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="using_drc_example.html" class="btn btn-neutral float-left" title="Design Rule Check Example" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, BYU Configurable Computing Lab.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>